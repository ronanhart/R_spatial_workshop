<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Spatial Analysis | R Spatial Workshop</title>
  <meta name="description" content="This workshop was created for USU’s Ecology Center R workshops on R Spatial." />
  <meta name="generator" content="bookdown 0.25 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Spatial Analysis | R Spatial Workshop" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This workshop was created for USU’s Ecology Center R workshops on R Spatial." />
  <meta name="github-repo" content="ronanhart/R_spatial_workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Spatial Analysis | R Spatial Workshop" />
  
  <meta name="twitter:description" content="This workshop was created for USU’s Ecology Center R workshops on R Spatial." />
  

<meta name="author" content="Ronan Hart" />


<meta name="date" content="2022-04-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="spatial-data-in-r.html"/>
<link rel="next" href="where-to-obtain-data-further-resources.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Ecology Center: R Spatial Workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcome to the Ecology Center’s Workshop on R Spatial!<span></span></a>
<ul>
<li><a href="index.html#why-gis-in-r">Why GIS in R?<span></span></a></li>
<li><a href="index.html#prerequisites-packages-and-preparation">Prerequisites, Packages, and Preparation<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="gis-basics.html"><a href="gis-basics.html"><i class="fa fa-check"></i><b>2</b> GIS basics<span></span></a>
<ul>
<li class="chapter" data-level="2.1" data-path="gis-basics.html"><a href="gis-basics.html#datums-projections-and-coordinate-systems"><i class="fa fa-check"></i><b>2.1</b> Datums, Projections, and Coordinate Systems<span></span></a>
<ul>
<li><a href="gis-basics.html#datums">Datums<span></span></a></li>
<li><a href="gis-basics.html#projections">Projections<span></span></a></li>
<li><a href="gis-basics.html#coordinate-reference-system">Coordinate Reference System<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="gis-basics.html"><a href="gis-basics.html#spatial-data"><i class="fa fa-check"></i><b>2.2</b> Spatial Data<span></span></a>
<ul>
<li><a href="gis-basics.html#vectors">Vectors<span></span></a></li>
<li><a href="gis-basics.html#rasters">Rasters<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="gis-basics.html"><a href="gis-basics.html#vectors-vs-rasters-pros-cons"><i class="fa fa-check"></i><b>2.3</b> Vectors vs Rasters: pros &amp; cons<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html"><i class="fa fa-check"></i><b>3</b> Spatial Data in R<span></span></a>
<ul>
<li class="chapter" data-level="3.1" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#vectors-1"><i class="fa fa-check"></i><b>3.1</b> Vectors<span></span></a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#loading-vector-data-from-a-spreadsheet"><i class="fa fa-check"></i><b>3.1.1</b> Loading vector data from a spreadsheet<span></span></a></li>
<li class="chapter" data-level="3.1.2" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#loading-vector-data"><i class="fa fa-check"></i><b>3.1.2</b> Loading vector data<span></span></a></li>
<li class="chapter" data-level="3.1.3" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#projecting-vector-data"><i class="fa fa-check"></i><b>3.1.3</b> Projecting vector data<span></span></a></li>
<li class="chapter" data-level="3.1.4" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#saving-vector-data"><i class="fa fa-check"></i><b>3.1.4</b> Saving vector data<span></span></a></li>
<li class="chapter" data-level="3.1.5" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#converting-between-sf-and-sp"><i class="fa fa-check"></i><b>3.1.5</b> Converting between <code>sf</code> and <code>sp</code><span></span></a></li>
<li><a href="spatial-data-in-r.html#a-note-about-sf-and-tidyverse">A note about <code>sf</code> and <code>tidyverse</code><span></span></a></li>
<li><a href="spatial-data-in-r.html#your-turn">Your Turn!<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#rasters-1"><i class="fa fa-check"></i><b>3.2</b> Rasters<span></span></a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#load-a-raster"><i class="fa fa-check"></i><b>3.2.1</b> Load a raster<span></span></a></li>
<li class="chapter" data-level="3.2.2" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#create-a-raster"><i class="fa fa-check"></i><b>3.2.2</b> Create a raster<span></span></a></li>
<li class="chapter" data-level="3.2.3" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#project-a-raster"><i class="fa fa-check"></i><b>3.2.3</b> Project a raster<span></span></a></li>
<li class="chapter" data-level="3.2.4" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#save-a-raster"><i class="fa fa-check"></i><b>3.2.4</b> Save a raster<span></span></a></li>
<li><a href="spatial-data-in-r.html#your-turn-1">Your Turn!<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spatial-analysis.html"><a href="spatial-analysis.html"><i class="fa fa-check"></i><b>4</b> Spatial Analysis<span></span></a>
<ul>
<li class="chapter" data-level="4.1" data-path="spatial-analysis.html"><a href="spatial-analysis.html#selecting-attributes"><i class="fa fa-check"></i><b>4.1</b> Selecting Attributes<span></span></a></li>
<li class="chapter" data-level="4.2" data-path="spatial-analysis.html"><a href="spatial-analysis.html#select-features-by-location"><i class="fa fa-check"></i><b>4.2</b> Select features by location<span></span></a></li>
<li class="chapter" data-level="4.3" data-path="spatial-analysis.html"><a href="spatial-analysis.html#joining-attributes"><i class="fa fa-check"></i><b>4.3</b> Joining Attributes<span></span></a></li>
<li class="chapter" data-level="4.4" data-path="spatial-analysis.html"><a href="spatial-analysis.html#cropping"><i class="fa fa-check"></i><b>4.4</b> Cropping<span></span></a>
<ul>
<li><a href="spatial-analysis.html#cropping-a-vector">Cropping a vector<span></span></a></li>
<li><a href="spatial-analysis.html#cropping-a-raster">Cropping a raster<span></span></a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="spatial-analysis.html"><a href="spatial-analysis.html#extract-raster-values"><i class="fa fa-check"></i><b>4.5</b> Extract Raster Values<span></span></a></li>
<li class="chapter" data-level="4.6" data-path="spatial-analysis.html"><a href="spatial-analysis.html#distance"><i class="fa fa-check"></i><b>4.6</b> Distance<span></span></a></li>
<li class="chapter" data-level="4.7" data-path="spatial-analysis.html"><a href="spatial-analysis.html#raster-cell-stats"><i class="fa fa-check"></i><b>4.7</b> Raster Cell Stats<span></span></a></li>
<li class="chapter" data-level="4.8" data-path="spatial-analysis.html"><a href="spatial-analysis.html#calculate-terrain-characteristics"><i class="fa fa-check"></i><b>4.8</b> Calculate Terrain Characteristics<span></span></a></li>
<li class="chapter" data-level="4.9" data-path="spatial-analysis.html"><a href="spatial-analysis.html#a-note-about-loops"><i class="fa fa-check"></i><b>4.9</b> A Note About Loops<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="where-to-obtain-data-further-resources.html"><a href="where-to-obtain-data-further-resources.html"><i class="fa fa-check"></i><b>5</b> Where to Obtain Data &amp; Further Resources<span></span></a>
<ul>
<li class="chapter" data-level="5.1" data-path="where-to-obtain-data-further-resources.html"><a href="where-to-obtain-data-further-resources.html#data-sources"><i class="fa fa-check"></i><b>5.1</b> Data Sources<span></span></a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="where-to-obtain-data-further-resources.html"><a href="where-to-obtain-data-further-resources.html#maps-package"><i class="fa fa-check"></i><b>5.1.1</b> <code>maps</code> package<span></span></a></li>
<li class="chapter" data-level="5.1.2" data-path="where-to-obtain-data-further-resources.html"><a href="where-to-obtain-data-further-resources.html#utah-gis"><i class="fa fa-check"></i><b>5.1.2</b> Utah GIS<span></span></a></li>
<li class="chapter" data-level="5.1.3" data-path="where-to-obtain-data-further-resources.html"><a href="where-to-obtain-data-further-resources.html#other-environmental-rasters"><i class="fa fa-check"></i><b>5.1.3</b> Other Environmental Rasters<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="where-to-obtain-data-further-resources.html"><a href="where-to-obtain-data-further-resources.html#more-resources"><i class="fa fa-check"></i><b>5.2</b> More Resources<span></span></a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="where-to-obtain-data-further-resources.html"><a href="where-to-obtain-data-further-resources.html#learn-more-about-gis-in-general"><i class="fa fa-check"></i><b>5.2.1</b> Learn more about GIS in general<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="where-to-obtain-data-further-resources.html"><a href="where-to-obtain-data-further-resources.html#acknowledgements"><i class="fa fa-check"></i><b>5.3</b> Acknowledgements<span></span></a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="where-to-obtain-data-further-resources.html"><a href="where-to-obtain-data-further-resources.html#figure-citations"><i class="fa fa-check"></i><b>5.3.1</b> Figure Citations<span></span></a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Spatial Workshop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-analysis" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Chapter 4</span> Spatial Analysis<a href="spatial-analysis.html#spatial-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Now let’s do some analysis with the data we’ve acquired already:</p>
<ul>
<li>Sites point data <code>sites_sf</code></li>
<li>Utah freeways <code>fwy_sf_proj</code></li>
</ul>
<p>We also have some data that I’ve included in the exercises portion of the “worksheet”: a different elevation + snow raster stack (this one is in the NW corner of Utah), a set of plots as a point feature, and a polygon feature of boundaries in Utah and who manages them:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="spatial-analysis.html#cb158-1" aria-hidden="true" tabindex="-1"></a>elev_snow_stk</span></code></pre></div>
<pre><code>## class      : RasterStack 
## dimensions : 7401, 5606, 41490006, 3  (nrow, ncol, ncell, nlayers)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## names      : elevation,      swe, snow_depth 
## min values :  1279.897,    0.000,      0.000 
## max values :    4111.6,   1108.0,     3196.0</code></pre>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="spatial-analysis.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(elev_snow_stk)</span></code></pre></div>
<p><img src="_main_files/figure-html/showRaster-1.png" width="672" /></p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="spatial-analysis.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plots_sf)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 1 field
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 499102.7 ymin: 4528029 xmax: 560979.8 ymax: 4622779
## Projected CRS: NAD83 / UTM zone 12N
##   Plots                 geometry
## 1     A POINT (537889.7 4593484)
## 2     B POINT (560979.8 4586311)
## 3     C POINT (544094.8 4548330)
## 4     D POINT (522850.5 4556870)
## 5     E POINT (551238.5 4528029)
## 6     F POINT (499102.7 4622779)</code></pre>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="spatial-analysis.html#cb163-1" aria-hidden="true" tabindex="-1"></a>manage_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&quot;data/Exercises/UT_land_management&quot;</span>, <span class="st">&quot;UT_land_management&quot;</span>,</span>
<span id="cb163-2"><a href="spatial-analysis.html#cb163-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">quiet =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb163-3"><a href="spatial-analysis.html#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">26912</span>)</span>
<span id="cb163-4"><a href="spatial-analysis.html#cb163-4" aria-hidden="true" tabindex="-1"></a>manage_sp <span class="ot">&lt;-</span> <span class="fu">as</span>(manage_sf, <span class="st">&quot;Spatial&quot;</span>)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 5 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 388066 ymin: 4410117 xmax: 403492.2 ymax: 4414856
## Projected CRS: NAD83 / UTM zone 12N
##   OBJECTID   OWNER AGENCY ADMIN          DESIG                       geometry
## 1        1 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((388854 4411...
## 2        2 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((394528.1 44...
## 3        3 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((388473.6 44...
## 4        4 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((399793.3 44...
## 5        5 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((389300.1 44...
## 6        6 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((403492.2 44...</code></pre>
<p><img src="_main_files/figure-html/showBound-1.png" width="672" /></p>
<p>Let’s plot one of the rasters with our sites point vector and Utah highways line vector. To plot just one raster layer in a stack we can either index it with double brackets or with the name:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="spatial-analysis.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co"># these are different ways to get the same raster layer</span></span>
<span id="cb165-2"><a href="spatial-analysis.html#cb165-2" aria-hidden="true" tabindex="-1"></a>elev_snow_stk[[<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## band       : 1  (of  3  bands)
## dimensions : 7401, 5606, 41490006  (nrow, ncol, ncell)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## source     : elev_snow_nw_stack.tif 
## names      : elevation 
## values     : 1279.897, 4111.6  (min, max)</code></pre>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="spatial-analysis.html#cb167-1" aria-hidden="true" tabindex="-1"></a>elev_snow_stk<span class="sc">$</span>elevation</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## band       : 1  (of  3  bands)
## dimensions : 7401, 5606, 41490006  (nrow, ncol, ncell)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## source     : elev_snow_nw_stack.tif 
## names      : elevation 
## values     : 1279.897, 4111.6  (min, max)</code></pre>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="spatial-analysis.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(elev_snow_stk<span class="sc">$</span>elevation)</span>
<span id="cb169-2"><a href="spatial-analysis.html#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(fwy_sp_proj, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="co"># lines() will plot the polyline on top of the plot (instead of drawing a new plot)</span></span>
<span id="cb169-3"><a href="spatial-analysis.html#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(sites_sp_proj, <span class="at">pch =</span> <span class="dv">16</span>) <span class="co"># points() will do the same as lines() except with point data</span></span>
<span id="cb169-4"><a href="spatial-analysis.html#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(plots_sp, <span class="at">pch =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/plotAll-1.png" width="672" /></p>
<p>(This can also be done with <code>ggplot</code> using <code>as.data.frame</code> but in this case the raster may be too large for R to convert to a dataframe and plot)</p>
<p>Let’s start on some analysis and computations that we can run on these data.</p>
<div id="selecting-attributes" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Selecting Attributes<a href="spatial-analysis.html#selecting-attributes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Perhaps you have vector data and you want to select only certain attributes or attributes that reach a focal threshold. To do so we need to set up a logical statement, and we can do this in base R or in <code>tidyverse</code>.</p>
<p>Let’s say we want to select boundaries that are operated by BLM. In the shapefile of management boundaries, this information is located in the column “AGENCY”</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="spatial-analysis.html#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(manage_sf<span class="sc">$</span>AGENCY)</span></code></pre></div>
<pre><code>##  [1] &quot;BLM&quot;     &quot;BR&quot;      &quot;DOD&quot;     &quot;DOE&quot;     &quot;NPS&quot;     &quot;USFS&quot;    &quot;USFWS&quot;  
##  [8] &quot;Private&quot; &quot;DNR&quot;     &quot;OS&quot;      &quot;SITLA&quot;   &quot;UDOT&quot;    &quot;Tribal&quot;</code></pre>
<p>In base R we can use the function <code>which</code> and in <code>tidyverse</code> we can use the function <code>filter</code></p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="spatial-analysis.html#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># base R</span></span>
<span id="cb172-2"><a href="spatial-analysis.html#cb172-2" aria-hidden="true" tabindex="-1"></a>blm_boundary <span class="ot">&lt;-</span> manage_sf[<span class="fu">which</span>(manage_sf<span class="sc">$</span>AGENCY <span class="sc">==</span> <span class="st">&quot;BLM&quot;</span>), ] <span class="co"># you can do this with sp objects too </span></span>
<span id="cb172-3"><a href="spatial-analysis.html#cb172-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-4"><a href="spatial-analysis.html#cb172-4" aria-hidden="true" tabindex="-1"></a><span class="co"># tidyverse</span></span>
<span id="cb172-5"><a href="spatial-analysis.html#cb172-5" aria-hidden="true" tabindex="-1"></a>blm_boundary <span class="ot">&lt;-</span> manage_sf <span class="sc">%&gt;%</span> <span class="co"># you cannot do this with sp objects</span></span>
<span id="cb172-6"><a href="spatial-analysis.html#cb172-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(AGENCY <span class="sc">==</span> <span class="st">&quot;BLM&quot;</span>)</span>
<span id="cb172-7"><a href="spatial-analysis.html#cb172-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-8"><a href="spatial-analysis.html#cb172-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb172-9"><a href="spatial-analysis.html#cb172-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> manage_sf, <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb172-10"><a href="spatial-analysis.html#cb172-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> blm_boundary, <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">col =</span> <span class="st">&quot;grey30&quot;</span>,</span>
<span id="cb172-11"><a href="spatial-analysis.html#cb172-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/selectBLM-1.png" width="672" /></p>
<p>Using these functions, you can set up any logical statement using <code>==</code>, <code>%in%</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>, or <code>!</code> and select for the specific attributes you need.</p>
</div>
<div id="select-features-by-location" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Select features by location<a href="spatial-analysis.html#select-features-by-location" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s make select the management boundaries based on if they are intersected by a major highway. For <code>sf</code> we’ll use the function <code>st_intersect</code> and for <code>sp</code> we’ll use</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="spatial-analysis.html#cb173-1" aria-hidden="true" tabindex="-1"></a>manage_roads <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(fwy_sf_proj, manage_sf) <span class="co"># the first argument is the target shape and the second argument the shape we&#39;re selecting from</span></span>
<span id="cb173-2"><a href="spatial-analysis.html#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(manage_roads)</span></code></pre></div>
<pre><code>## [1] &quot;sgbp&quot; &quot;list&quot;</code></pre>
<p>The output is an <code>sgbp</code> object, or “Sparse Geometry Binary Predicate”. Basically it returns a list of vectors of integers, which refer to the indices of each polygon that intersects.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="spatial-analysis.html#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(manage_roads)</span></code></pre></div>
<pre><code>## [1]  1849 14888</code></pre>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="spatial-analysis.html#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(fwy_sf_proj)</span></code></pre></div>
<pre><code>## [1] 1849</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="spatial-analysis.html#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(manage_sf)</span></code></pre></div>
<pre><code>## [1] 14888</code></pre>
<p>So the dimensions of this list are the the number of rows in the target shape (the highways) and the number of rows in the intersecting shape (the management boundaries). If we wanted to know the specifc index of a specific road that intersected with a management boundary, it would be useful to keep all of these indices seperate. Since we just want to know which boundaries intersect a road, we can collapse this whole list together.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="spatial-analysis.html#cb181-1" aria-hidden="true" tabindex="-1"></a>manage_roads_index <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">unlist</span>(manage_roads)) <span class="co"># just pull the unique indices</span></span>
<span id="cb181-2"><a href="spatial-analysis.html#cb181-2" aria-hidden="true" tabindex="-1"></a>manage_roads_intersect <span class="ot">&lt;-</span> manage_sf[manage_roads_index, ]</span>
<span id="cb181-3"><a href="spatial-analysis.html#cb181-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-4"><a href="spatial-analysis.html#cb181-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb181-5"><a href="spatial-analysis.html#cb181-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> manage_sf, <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb181-6"><a href="spatial-analysis.html#cb181-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> manage_roads_intersect, <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">col =</span> <span class="st">&quot;grey30&quot;</span>,</span>
<span id="cb181-7"><a href="spatial-analysis.html#cb181-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb181-8"><a href="spatial-analysis.html#cb181-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> fwy_sf_proj, <span class="at">col =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/intersect-1.png" width="672" /></p>
<p>If you look at the help file for <code>?st_intersects</code>, you’ll see there are a lot of different functions that select features based on another feature.</p>
</div>
<div id="joining-attributes" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Joining Attributes<a href="spatial-analysis.html#joining-attributes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s load in a table of some data collected at each plot</p>
<pre><code>##   Plots      Species       Date AboveGroundBiomass MeanHeight PercentCover
## 1     A R. maritimus 2021-05-01           27.61158  3.7257421     77.75151
## 2     A    B. cernua 2021-05-01           13.18637  4.5355917     65.06243
## 3     A    S. acutus 2021-05-01           68.84413  1.8172373     98.39445
## 4     B R. maritimus 2021-05-02           59.58161  1.2949173     28.84727
## 5     B    B. cernua 2021-05-02           87.44708  0.7372426     48.40372
## 6     B    S. acutus 2021-05-02           35.32842  2.6436731     95.73950</code></pre>
<p>Let’s join this table to the Plots feature so we could do some spatial analysis and mapping of the collected data. To join two tables together, we need to input the two tables and the name of the column that exists in both tables (so the join function knows how to match attributes together). In this case, that would be the Plots column.</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="spatial-analysis.html#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plots_sf<span class="sc">$</span>Plots)</span></code></pre></div>
<pre><code>## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot; &quot;D&quot; &quot;E&quot; &quot;F&quot;</code></pre>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="spatial-analysis.html#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plot_data<span class="sc">$</span>Plots)</span></code></pre></div>
<pre><code>## [1] &quot;A&quot; &quot;A&quot; &quot;A&quot; &quot;B&quot; &quot;B&quot; &quot;B&quot;</code></pre>
<p>We can use the <code>tidyverse</code>’s <code>join</code> functions. (If you don’t know how joins work, I would recommend looking at the help file by typing <code>?left_join</code> in the console)</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="spatial-analysis.html#cb187-1" aria-hidden="true" tabindex="-1"></a>plots_join <span class="ot">&lt;-</span> <span class="fu">left_join</span>(plots_sf, plot_data, <span class="at">by =</span> <span class="st">&quot;Plots&quot;</span>)</span>
<span id="cb187-2"><a href="spatial-analysis.html#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plots_join)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 6 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 537889.7 ymin: 4593484 xmax: 537889.7 ymax: 4593484
## Projected CRS: NAD83 / UTM zone 12N
##   Plots      Species       Date AboveGroundBiomass MeanHeight PercentCover
## 1     A R. maritimus 2021-05-01           27.61158  3.7257421     77.75151
## 2     A    B. cernua 2021-05-01           13.18637  4.5355917     65.06243
## 3     A    S. acutus 2021-05-01           68.84413  1.8172373     98.39445
## 4     A R. maritimus 2021-05-08           42.73997  0.5477968     65.87027
## 5     A    B. cernua 2021-05-08           68.90326  1.9793263     11.35618
## 6     A    S. acutus 2021-05-08           44.42221  0.4002126     90.92433
##                   geometry
## 1 POINT (537889.7 4593484)
## 2 POINT (537889.7 4593484)
## 3 POINT (537889.7 4593484)
## 4 POINT (537889.7 4593484)
## 5 POINT (537889.7 4593484)
## 6 POINT (537889.7 4593484)</code></pre>
<p>Great! At this point you could then do some spatial analysis based on location, or make a map based on average biomass, for example. However, that’s outside the scope of this workshop.</p>
<p>Joining two tables together is a valuable tool to know, not just for GIS but for any data management.</p>
</div>
<div id="cropping" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> Cropping<a href="spatial-analysis.html#cropping" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="cropping-a-vector" class="section level3 unnumbered hasAnchor">
<h3>Cropping a vector<a href="spatial-analysis.html#cropping-a-vector" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If you noticed earlier, the highway polyline runs outside of the elevation raster. What if we want to crop the vector so that it falls only within the raster?</p>
<p>For <code>sf</code> we’ll use the function <code>st_crop</code> (which requires an object of class <code>sf</code> or <code>sfc</code> and the min/max x &amp; y extent we want to crop the feature to). For <code>sp</code> we’ll use the function <code>crop</code>. (<code>crop</code> is actually in the <code>raster</code> package, but remember that <code>raster</code> is dependent on <code>sp</code>? That means that some <code>raster</code> functions can be used on <code>Spatial*</code> objects too). For <code>crop</code> we need the object we’re cropping and the extent we’re cropping to (or an object that an extent can be derived from, in this case the raster itself)</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="spatial-analysis.html#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sf:</span></span>
<span id="cb189-2"><a href="spatial-analysis.html#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="co"># First we need the extent of the raster that is compatible with sf. For that we&#39;ll use st_bbox()</span></span>
<span id="cb189-3"><a href="spatial-analysis.html#cb189-3" aria-hidden="true" tabindex="-1"></a>rast_ext <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(<span class="fu">extent</span>(elev_snow_stk))</span>
<span id="cb189-4"><a href="spatial-analysis.html#cb189-4" aria-hidden="true" tabindex="-1"></a>rast_ext</span></code></pre></div>
<pre><code>##      xmin      ymin      xmax      ymax 
##  414639.5 4428229.8  582819.5 4650259.8</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="spatial-analysis.html#cb191-1" aria-hidden="true" tabindex="-1"></a>fwy_crop_sf <span class="ot">&lt;-</span> <span class="fu">st_crop</span>(fwy_sf_proj, rast_ext)</span>
<span id="cb191-2"><a href="spatial-analysis.html#cb191-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3"><a href="spatial-analysis.html#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sp:</span></span>
<span id="cb191-4"><a href="spatial-analysis.html#cb191-4" aria-hidden="true" tabindex="-1"></a>fwy_crop_sp <span class="ot">&lt;-</span> <span class="fu">crop</span>(fwy_sp_proj, elev_snow_stk)</span></code></pre></div>
<p><img src="_main_files/figure-html/checkCrop-1.png" width="672" /></p>
</div>
<div id="cropping-a-raster" class="section level3 unnumbered hasAnchor">
<h3>Cropping a raster<a href="spatial-analysis.html#cropping-a-raster" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can also easily crop a raster. Let’s say we wanted to crop our raster stack down to only the area around our site that’s in the Uintas</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="spatial-analysis.html#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(elev_snow_stk<span class="sc">$</span>elevation)</span>
<span id="cb192-2"><a href="spatial-analysis.html#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(sites_sp_proj, <span class="at">pch =</span> <span class="dv">16</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plotSites"></span>
<img src="_main_files/figure-html/plotSites-1.png" alt="the Uintas are that high-elevation mountain range in the middle right of this map" width="672" />
<p class="caption">
Figure 4.1: the Uintas are that high-elevation mountain range in the middle right of this map
</p>
</div>
<p>First we need to find out what site number that is. We’ll use the <code>text()</code> function. There is a <code>text()</code> function for base R plotting, but the <code>raster</code> package adapted that function to plot text from rasters and <code>Spatial*</code> objects. Let’s use that function, so we need to specify which package it comes from using <code>raster::</code></p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="spatial-analysis.html#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(elev_snow_stk<span class="sc">$</span>elevation)</span>
<span id="cb193-2"><a href="spatial-analysis.html#cb193-2" aria-hidden="true" tabindex="-1"></a>raster<span class="sc">::</span><span class="fu">text</span>(sites_sp_proj, <span class="at">labels =</span> <span class="st">&quot;Site&quot;</span>, <span class="at">halo =</span> T)</span></code></pre></div>
<p><img src="_main_files/figure-html/checkSiteN-1.png" width="672" /></p>
<p>Site 8! Let’s filter our spatial data to just this site.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="spatial-analysis.html#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># base R</span></span>
<span id="cb194-2"><a href="spatial-analysis.html#cb194-2" aria-hidden="true" tabindex="-1"></a>site_8 <span class="ot">&lt;-</span> sites_sf_proj[<span class="fu">which</span>(sites_sf_proj<span class="sc">$</span>Site <span class="sc">==</span> <span class="dv">8</span>), ] <span class="co"># remember that you can use this method for sp objects too</span></span>
<span id="cb194-3"><a href="spatial-analysis.html#cb194-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-4"><a href="spatial-analysis.html#cb194-4" aria-hidden="true" tabindex="-1"></a><span class="co"># tidyverse</span></span>
<span id="cb194-5"><a href="spatial-analysis.html#cb194-5" aria-hidden="true" tabindex="-1"></a>site_8 <span class="ot">&lt;-</span> sites_sf_proj <span class="sc">%&gt;%</span></span>
<span id="cb194-6"><a href="spatial-analysis.html#cb194-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Site <span class="sc">==</span> <span class="dv">8</span>)</span>
<span id="cb194-7"><a href="spatial-analysis.html#cb194-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-8"><a href="spatial-analysis.html#cb194-8" aria-hidden="true" tabindex="-1"></a>site_8</span></code></pre></div>
<pre><code>## Simple feature collection with 1 feature and 1 field
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 564670.6 ymin: 4513862 xmax: 564670.6 ymax: 4513862
## Projected CRS: NAD83 / UTM zone 12N
##   Site                 geometry
## 1    8 POINT (564670.6 4513862)</code></pre>
<p>But we don’t want to crop the raster down to a single point, so let’s first make a buffer (5kmX5km) around this specific site. We’ll use <code>st_buffer()</code> to do so.</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="spatial-analysis.html#cb196-1" aria-hidden="true" tabindex="-1"></a>buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(site_8, <span class="at">dist =</span> <span class="dv">5000</span>) <span class="co"># units are in meters</span></span>
<span id="cb196-2"><a href="spatial-analysis.html#cb196-2" aria-hidden="true" tabindex="-1"></a>buffer</span></code></pre></div>
<pre><code>## Simple feature collection with 1 feature and 1 field
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 559670.6 ymin: 4508862 xmax: 569670.6 ymax: 4518862
## Projected CRS: NAD83 / UTM zone 12N
##   Site                       geometry
## 1    8 POLYGON ((569670.6 4513862,...</code></pre>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="spatial-analysis.html#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb198-2"><a href="spatial-analysis.html#cb198-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> buffer) <span class="sc">+</span></span>
<span id="cb198-3"><a href="spatial-analysis.html#cb198-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> site_8, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb198-4"><a href="spatial-analysis.html#cb198-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">datum =</span> <span class="fu">st_crs</span>(<span class="dv">26912</span>)) <span class="co"># this plots the axes to UTM coordinates instead of latlong coordinates</span></span></code></pre></div>
<p><img src="_main_files/figure-html/buffer-1.png" width="672" /></p>
<p>To crop a raster, we’ll use the same function we used to crop a <code>Spatial*</code> object: <code>crop</code>. Remember that I said earlier that any function we perform on a stack of rasters will run for every raster in that stack!</p>
<p>Earlier when we used <code>crop</code>, we could just put in the object itself and the function would automatically crop to the extent of that object. But that only works for objects of class <code>Raster*</code>, <code>Spatial*</code>, or <code>Extent</code>. Because our buffer is of class <code>sf</code>, we can’t just put the object itself in. Instead we need to put in its extent (<em>or</em> you could convert the buffer to a <code>Spatial*</code> object)</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="spatial-analysis.html#cb199-1" aria-hidden="true" tabindex="-1"></a>stack_crop <span class="ot">&lt;-</span> <span class="fu">crop</span>(elev_snow_stk, <span class="fu">extent</span>(buffer))</span>
<span id="cb199-2"><a href="spatial-analysis.html#cb199-2" aria-hidden="true" tabindex="-1"></a>stack_crop</span></code></pre></div>
<pre><code>## class      : RasterBrick 
## dimensions : 333, 334, 111222, 3  (nrow, ncol, ncell, nlayers)
## resolution : 30, 30  (x, y)
## extent     : 559659.5, 569679.5, 4508870, 4518860  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## source     : memory
## names      : elevation,      swe, snow_depth 
## min values :   2714.15,   148.00,     680.00 
## max values :  3811.196,  427.000,   1453.000</code></pre>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="spatial-analysis.html#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stack_crop)</span></code></pre></div>
<p><img src="_main_files/figure-html/cropRast-1.png" width="672" /></p>
<p><img src="_main_files/figure-html/checkCropR-1.png" width="672" /></p>
</div>
</div>
<div id="extract-raster-values" class="section level2 hasAnchor" number="4.5">
<h2><span class="header-section-number">4.5</span> Extract Raster Values<a href="spatial-analysis.html#extract-raster-values" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>What if we need to get data from our rasters at our specific site locations? We can use the function <code>extract()</code>.</p>
<p>Let’s load a landcover raster so we can classify the habitat types of our sites</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="spatial-analysis.html#cb202-1" aria-hidden="true" tabindex="-1"></a>landcover <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="st">&quot;Data/Examples/landcover.tif&quot;</span>)</span>
<span id="cb202-2"><a href="spatial-analysis.html#cb202-2" aria-hidden="true" tabindex="-1"></a>landcover</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## dimensions : 18675, 14838, 277099650  (nrow, ncol, ncell)
## resolution : 30, 30  (x, y)
## extent     : 229319.6, 674459.6, 4094414, 4654664  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## source     : landcover.tif 
## names      : landcover 
## values     : 137, 584  (min, max)</code></pre>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="spatial-analysis.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(landcover)</span>
<span id="cb204-2"><a href="spatial-analysis.html#cb204-2" aria-hidden="true" tabindex="-1"></a>raster<span class="sc">::</span><span class="fu">text</span>(sites_sp_proj, <span class="at">labels =</span> <span class="st">&quot;Site&quot;</span>, <span class="at">halo =</span> T)</span></code></pre></div>
<p><img src="_main_files/figure-html/landcover-1.png" width="672" /></p>
<p><code>extract</code> returns a vector whose indices match the indices of the spatial object. We could leave it as a vector, or we could automatically attach it to the dataframe using <code>$</code></p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="spatial-analysis.html#cb205-1" aria-hidden="true" tabindex="-1"></a>sites_sf_proj<span class="sc">$</span>land_value <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">extract</span>(landcover, sites_sp_proj)</span>
<span id="cb205-2"><a href="spatial-analysis.html#cb205-2" aria-hidden="true" tabindex="-1"></a>sites_sf_proj</span></code></pre></div>
<pre><code>## Simple feature collection with 10 features and 2 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 287581.9 ymin: 4157301 xmax: 656513.7 ymax: 4595255
## Projected CRS: NAD83 / UTM zone 12N
##    Site                 geometry land_value
## 1     1 POINT (516801.7 4188305)        547
## 2     2 POINT (470663.6 4322073)        491
## 3     3 POINT (656513.7 4212358)        561
## 4     4 POINT (311534.1 4398520)        498
## 5     5 POINT (454023.6 4595255)        187
## 6     6 POINT (455210.1 4289185)        151
## 7     7 POINT (420826.5 4351553)        457
## 8     8 POINT (564670.6 4513862)        152
## 9     9 POINT (287581.9 4469956)        458
## 10   10 POINT (377495.7 4157301)        158</code></pre>
<p>Ok but what do these numbers mean? Our landcover raster is a categorical raster, so these numbers aren’t actually real numbers but represent a habitat type. Fortunately we have a dataframe indicating what these numbers mean.</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="spatial-analysis.html#cb207-1" aria-hidden="true" tabindex="-1"></a>land_info <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;Data/Examples/landcover_info.csv&quot;</span>)</span>
<span id="cb207-2"><a href="spatial-analysis.html#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(land_info)[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>##   Value ClassCode         ClassName SubClassCode               SubClassName
## 1     1         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 2     2         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 3     3         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 4     4         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 5     5         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 6     6         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland</code></pre>
<p>The column “Value” corresponds to the cell value we extracted from the raster. We can use what we learned earlier how to join two tables together, but first we need to make sure the ID column (“Value”) for both tables are named the same.</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="spatial-analysis.html#cb209-1" aria-hidden="true" tabindex="-1"></a>sites_sf_land <span class="ot">&lt;-</span> sites_sf_proj <span class="sc">%&gt;%</span></span>
<span id="cb209-2"><a href="spatial-analysis.html#cb209-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Value =</span> land_value) <span class="sc">%&gt;%</span> <span class="co"># rename the column so it matches in both tables</span></span>
<span id="cb209-3"><a href="spatial-analysis.html#cb209-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(land_info, <span class="at">by =</span> <span class="st">&quot;Value&quot;</span>) <span class="co"># join by the column &quot;Value&quot;</span></span>
<span id="cb209-4"><a href="spatial-analysis.html#cb209-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sites_sf_land)[,<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 6 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 311534.1 ymin: 4188305 xmax: 656513.7 ymax: 4595255
## Projected CRS: NAD83 / UTM zone 12N
##   Site Value ClassCode                            ClassName SubClassCode
## 1    1   547         6                 Open Rock Vegetation          3.B
## 2    2   491         3                 Desert &amp; Semi-Desert          3.B
## 3    3   561         9 Introduced &amp; Semi Natural Vegetation          9.A
## 4    4   498         3                 Desert &amp; Semi-Desert          3.B
## 5    5   187         1                    Forest &amp; Woodland          1.B
## 6    6   151         1                    Forest &amp; Woodland          1.B
##                           SubClassName                 geometry
## 1   Cool Semi-Desert Scrub &amp; Grassland POINT (516801.7 4188305)
## 2   Cool Semi-Desert Scrub &amp; Grassland POINT (470663.6 4322073)
## 3 Introduced &amp; Semi Natural Vegetation POINT (656513.7 4212358)
## 4   Cool Semi-Desert Scrub &amp; Grassland POINT (311534.1 4398520)
## 5 Temperate &amp; Boreal Forest &amp; Woodland POINT (454023.6 4595255)
## 6 Temperate &amp; Boreal Forest &amp; Woodland POINT (455210.1 4289185)</code></pre>
<p><img src="_main_files/figure-html/plotLandPoints-1.png" width="672" /></p>
<p>Awesome!</p>
</div>
<div id="distance" class="section level2 hasAnchor" number="4.6">
<h2><span class="header-section-number">4.6</span> Distance<a href="spatial-analysis.html#distance" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s say we needed to know how far from a major road each of our sites are. We’ll use the function <code>st_distance</code> for our <code>sf</code> objects. We simply need to input the focal feature (the sites) and the feature</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="spatial-analysis.html#cb211-1" aria-hidden="true" tabindex="-1"></a>dist <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(sites_sf_proj, fwy_sf_proj)</span>
<span id="cb211-2"><a href="spatial-analysis.html#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(dist)</span></code></pre></div>
<pre><code>## [1]   10 1849</code></pre>
<p>What did this do? Why are there so many columns? Remember that our Utah highways feature is a <strong>poly</strong>line, meaning it’s a line of lines. If we look at the dimensions of the highways feature:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="spatial-analysis.html#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(fwy_sf_proj)</span></code></pre></div>
<pre><code>## [1] 1849</code></pre>
<p>There are <strong>1849</strong> lines (i.e. roads) that make up this whole feature. So <code>st_distance</code> found the distance for each site (the number of rows) for <em>every</em> road (the number of columns). This <em>could</em> be useful information, but presumably we want just the distance of the <em>closest</em> road. To find that distance, we’ll have to do some data frame manipulation.</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="spatial-analysis.html#cb215-1" aria-hidden="true" tabindex="-1"></a>dist_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dist)</span>
<span id="cb215-2"><a href="spatial-analysis.html#cb215-2" aria-hidden="true" tabindex="-1"></a>dist_df[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>##              V1           V2           V3            V4            V5
## 1 338437.85 [m] 263692.1 [m] 377476.0 [m] 390771.33 [m] 362734.97 [m]
## 2 197203.45 [m] 122621.7 [m] 236789.3 [m] 249791.82 [m] 223192.16 [m]
## 3 381617.18 [m] 312604.5 [m] 413268.8 [m] 427894.89 [m] 393571.41 [m]
## 4 158689.76 [m] 139533.6 [m] 192053.6 [m] 196516.46 [m] 196519.69 [m]
## 5  88374.99 [m] 153727.1 [m]  50524.9 [m]  48850.39 [m]  52407.25 [m]</code></pre>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="spatial-analysis.html#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dist_df) <span class="ot">&lt;-</span> fwy_sf_proj<span class="sc">$</span>UNIQUE_ID</span>
<span id="cb217-2"><a href="spatial-analysis.html#cb217-2" aria-hidden="true" tabindex="-1"></a>dist_df <span class="ot">&lt;-</span> dist_df <span class="sc">%&gt;%</span></span>
<span id="cb217-3"><a href="spatial-analysis.html#cb217-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Site =</span> sites_sf_proj<span class="sc">$</span>Site) <span class="sc">%&gt;%</span> <span class="co"># add a column for Sites</span></span>
<span id="cb217-4"><a href="spatial-analysis.html#cb217-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(Site, <span class="at">.before =</span> <span class="fu">colnames</span>(dist_df)[<span class="dv">1</span>]) <span class="co"># move to the front of the dataframe</span></span>
<span id="cb217-5"><a href="spatial-analysis.html#cb217-5" aria-hidden="true" tabindex="-1"></a>dist_df[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>##   Site 12TVL21421309_I-80 EB_FWY 12TVK44214181_I-15 NB_FWY
## 1    1             338437.85 [m]              263692.1 [m]
## 2    2             197203.45 [m]              122621.7 [m]
## 3    3             381617.18 [m]              312604.5 [m]
## 4    4             158689.76 [m]              139533.6 [m]
## 5    5              88374.99 [m]              153727.1 [m]
##   12TVL528848324_I-84 WB_FWY 12TVL14996575_I-15 NB_FWY
## 1               377476.0 [m]             390771.33 [m]
## 2               236789.3 [m]             249791.82 [m]
## 3               413268.8 [m]             427894.89 [m]
## 4               192053.6 [m]             196516.46 [m]
## 5                50524.9 [m]              48850.39 [m]</code></pre>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="spatial-analysis.html#cb219-1" aria-hidden="true" tabindex="-1"></a>dist_df <span class="ot">&lt;-</span> dist_df <span class="sc">%&gt;%</span></span>
<span id="cb219-2"><a href="spatial-analysis.html#cb219-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Site, <span class="at">names_to =</span> <span class="st">&quot;Road_Name&quot;</span>)</span>
<span id="cb219-3"><a href="spatial-analysis.html#cb219-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dist_df)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##    Site Road_Name                    value
##   &lt;int&gt; &lt;chr&gt;                          [m]
## 1     1 12TVL21421309_I-80 EB_FWY  338438.
## 2     1 12TVK44214181_I-15 NB_FWY  263692.
## 3     1 12TVL528848324_I-84 WB_FWY 377476.
## 4     1 12TVL14996575_I-15 NB_FWY  390771.
## 5     1 12TVL43954376_I-84 WB_FWY  362735.
## 6     1 12TVL22992231_I-15 NB_FWY  346788.</code></pre>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="spatial-analysis.html#cb221-1" aria-hidden="true" tabindex="-1"></a>dist_df <span class="ot">&lt;-</span> dist_df <span class="sc">%&gt;%</span></span>
<span id="cb221-2"><a href="spatial-analysis.html#cb221-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Site) <span class="sc">%&gt;%</span></span>
<span id="cb221-3"><a href="spatial-analysis.html#cb221-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Distance =</span> <span class="fu">min</span>(value)) <span class="sc">%&gt;%</span></span>
<span id="cb221-4"><a href="spatial-analysis.html#cb221-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">==</span> Distance) <span class="sc">%&gt;%</span></span>
<span id="cb221-5"><a href="spatial-analysis.html#cb221-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>value)</span>
<span id="cb221-6"><a href="spatial-analysis.html#cb221-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dist_df)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
## # Groups:   Site [6]
##    Site Road_Name                  Distance
##   &lt;int&gt; &lt;chr&gt;                           [m]
## 1     1 12SWH795644729_I-70 EB_FWY  111639.
## 2     2 12SVH54839499_I-70 WB_FWY    26694.
## 3     3 12SXJ29161112_I-70 EB_FWY   100145.
## 4     4 12SVJ06965812_I-15 SB_FWY   103257.
## 5     5 12TVL12119352_I-15 NB_FWY    41944.
## 6     6 12SVH54609503_I-70 EB_FWY     4126.</code></pre>
<p>We could then join this information to our Sites feature</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="spatial-analysis.html#cb223-1" aria-hidden="true" tabindex="-1"></a>sites_sf_proj <span class="ot">&lt;-</span> <span class="fu">left_join</span>(sites_sf_proj, dist_df, <span class="at">by =</span> <span class="st">&quot;Site&quot;</span>)</span>
<span id="cb223-2"><a href="spatial-analysis.html#cb223-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sites_sf_proj)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 4 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 311534.1 ymin: 4188305 xmax: 656513.7 ymax: 4595255
## Projected CRS: NAD83 / UTM zone 12N
##   Site land_value                  Road_Name       Distance
## 1    1        547 12SWH795644729_I-70 EB_FWY 111639.222 [m]
## 2    2        491  12SVH54839499_I-70 WB_FWY  26693.741 [m]
## 3    3        561  12SXJ29161112_I-70 EB_FWY 100145.037 [m]
## 4    4        498  12SVJ06965812_I-15 SB_FWY 103257.143 [m]
## 5    5        187  12TVL12119352_I-15 NB_FWY  41943.649 [m]
## 6    6        151  12SVH54609503_I-70 EB_FWY   4125.821 [m]
##                   geometry
## 1 POINT (516801.7 4188305)
## 2 POINT (470663.6 4322073)
## 3 POINT (656513.7 4212358)
## 4 POINT (311534.1 4398520)
## 5 POINT (454023.6 4595255)
## 6 POINT (455210.1 4289185)</code></pre>
<p>(Note that if you look at the help file i.e. <code>?st_distance</code>, there are other functions to calculate geometric measurements for <code>sf</code> objects: <code>st_area</code> and <code>st_length</code>)</p>
</div>
<div id="raster-cell-stats" class="section level2 hasAnchor" number="4.7">
<h2><span class="header-section-number">4.7</span> Raster Cell Stats<a href="spatial-analysis.html#raster-cell-stats" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In my research I often have to perform cell algebra or focal statistics. Maybe you need to know the average elevation or the total herbaceous biomass within a certain area. The way to get these values are with the function <code>cellStats</code>. We simply need to input the raster and the <code>stat</code> function: sum, mean, min, max, sd, or a homemade function. Let’s say we need to calculate the average elevation, SWE, and snow depth within the buffer we made earlier.</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="spatial-analysis.html#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cellStats</span>(stack_crop, <span class="at">stat =</span> <span class="st">&quot;mean&quot;</span>)</span></code></pre></div>
<pre><code>##  elevation        swe snow_depth 
##  3281.0344   319.1429  1145.2181</code></pre>
<p>Note that there’s an option to include <code>na.rm</code> in the arguments. <code>na.rm = TRUE</code> is the default.</p>
</div>
<div id="calculate-terrain-characteristics" class="section level2 hasAnchor" number="4.8">
<h2><span class="header-section-number">4.8</span> Calculate Terrain Characteristics<a href="spatial-analysis.html#calculate-terrain-characteristics" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>From a DEM (digital elevation model) we can obtain a lot of other rasters that are likely useful in GIS research. The elevation raster we’ve been working with is a DEM. From a DEM we can derive other terrain characteristics :</p>
<ul>
<li>Slope: Measurement of “steepness”</li>
<li>Aspect: Measurements of “Northness” and “Eastness”</li>
<li>Flow direction of water: the direction of the greatest drop in elevation</li>
<li>Terrain Ruggedness Index (TRI): the mean of the absolute differences between the value of a cell and the value of its 8 surrounding cells</li>
<li>Topographic Position Index (TPI): the difference between the value of a cell and the mean value of its 8 surrounding cells</li>
<li>Roughness: the difference between the maximum and the minimum value of a cell and its 8 surrounding cells</li>
</ul>
<p>These definitions came from the help file for the function we can use to derive these characteristics: <code>terrain()</code>.</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="spatial-analysis.html#cb227-1" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">terrain</span>(elev_snow_stk<span class="sc">$</span>elevation, <span class="at">opt =</span> <span class="st">&quot;slope&quot;</span>, <span class="at">unit =</span> <span class="st">&quot;radians&quot;</span>)</span>
<span id="cb227-2"><a href="spatial-analysis.html#cb227-2" aria-hidden="true" tabindex="-1"></a>aspect <span class="ot">&lt;-</span> <span class="fu">terrain</span>(elev_snow_stk<span class="sc">$</span>elevation, <span class="at">opt =</span> <span class="st">&quot;aspect&quot;</span>, <span class="at">unit =</span> <span class="st">&quot;radians&quot;</span>)</span>
<span id="cb227-3"><a href="spatial-analysis.html#cb227-3" aria-hidden="true" tabindex="-1"></a>roughness <span class="ot">&lt;-</span> <span class="fu">terrain</span>(elev_snow_stk<span class="sc">$</span>elevation, <span class="at">opt =</span> <span class="st">&quot;roughness&quot;</span>)</span>
<span id="cb227-4"><a href="spatial-analysis.html#cb227-4" aria-hidden="true" tabindex="-1"></a>terrain_stk <span class="ot">&lt;-</span> <span class="fu">stack</span>(elev_snow_stk<span class="sc">$</span>elevation, slope, aspect, roughness)</span>
<span id="cb227-5"><a href="spatial-analysis.html#cb227-5" aria-hidden="true" tabindex="-1"></a>terrain_stk</span></code></pre></div>
<pre><code>## class      : RasterStack 
## dimensions : 7401, 5606, 41490006, 4  (nrow, ncol, ncell, nlayers)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## names      :   elevation,       slope,      aspect,   roughness 
## min values :    1279.897,       0.000,       0.000,       0.000 
## max values : 4111.600098,    1.302171,    6.283185,  279.081787</code></pre>
<p><img src="_main_files/figure-html/loadStk-1.png" width="672" /></p>
<p>To compute the Northness or Eastness of a cell, we actually have to do one more step to the aspect raster. Aspect is a circular measurement (which is why its units are in degrees or radians), so (if you remember how trigonometry works) to calculate northness and eastness we need to use cosine and sine respectively. Because our units are in radians, we can simply apply the <code>cos()</code> and <code>sin()</code> functions directly to the aspect raster.</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="spatial-analysis.html#cb229-1" aria-hidden="true" tabindex="-1"></a>aspect_cos <span class="ot">&lt;-</span> <span class="fu">cos</span>(terrain_stk<span class="sc">$</span>aspect)</span>
<span id="cb229-2"><a href="spatial-analysis.html#cb229-2" aria-hidden="true" tabindex="-1"></a>aspect_sin <span class="ot">&lt;-</span> <span class="fu">sin</span>(terrain_stk<span class="sc">$</span>aspect)</span>
<span id="cb229-3"><a href="spatial-analysis.html#cb229-3" aria-hidden="true" tabindex="-1"></a>aspect_stk <span class="ot">&lt;-</span> <span class="fu">stack</span>(aspect_cos, aspect_sin)</span>
<span id="cb229-4"><a href="spatial-analysis.html#cb229-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(aspect_stk) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;cosine_northness&quot;</span>, <span class="st">&quot;sine_eastness&quot;</span>)</span>
<span id="cb229-5"><a href="spatial-analysis.html#cb229-5" aria-hidden="true" tabindex="-1"></a>aspect_stk</span></code></pre></div>
<pre><code>## class      : RasterStack 
## dimensions : 7401, 5606, 41490006, 2  (nrow, ncol, ncell, nlayers)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## names      : cosine_northness, sine_eastness 
## min values :               -1,            -1 
## max values :                1,             1</code></pre>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="spatial-analysis.html#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aspect_stk)</span></code></pre></div>
<p><img src="_main_files/figure-html/cosSine-1.png" width="672" /></p>
</div>
<div id="a-note-about-loops" class="section level2 hasAnchor" number="4.9">
<h2><span class="header-section-number">4.9</span> A Note About Loops<a href="spatial-analysis.html#a-note-about-loops" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Learning all these functions is all well and good, but what if you have to perform them all on multiple features or rasters? Of course, you can always copy and paste, but that can soon become confusing and messy and cause your code to be inefficient. The better way to address this is with loops! <code>for</code> loops and <code>lapply</code> are lifesavers and I use them in all of my code. A previous workshop went into more depth on how to use loops, so I won’t go over them in too much detail. But I do want to show some ways you can use them for GIS applications.</p>
<p>(These code chunks are for demonstration only, these data and directories don’t actually exist)</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="spatial-analysis.html#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example 1: Load a set of shapefiles and find the area for each</span></span>
<span id="cb232-2"><a href="spatial-analysis.html#cb232-2" aria-hidden="true" tabindex="-1"></a>filenames <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir) <span class="co"># get a list of shapefile names in a directory</span></span>
<span id="cb232-3"><a href="spatial-analysis.html#cb232-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-4"><a href="spatial-analysis.html#cb232-4" aria-hidden="true" tabindex="-1"></a>area_list <span class="ot">&lt;-</span> <span class="fu">c</span>() <span class="co"># create an empty vector for the areas to live in </span></span>
<span id="cb232-5"><a href="spatial-analysis.html#cb232-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-6"><a href="spatial-analysis.html#cb232-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(filenames)){</span>
<span id="cb232-7"><a href="spatial-analysis.html#cb232-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the shapefile</span></span>
<span id="cb232-8"><a href="spatial-analysis.html#cb232-8" aria-hidden="true" tabindex="-1"></a>  shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(filenames[i])</span>
<span id="cb232-9"><a href="spatial-analysis.html#cb232-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-10"><a href="spatial-analysis.html#cb232-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the area</span></span>
<span id="cb232-11"><a href="spatial-analysis.html#cb232-11" aria-hidden="true" tabindex="-1"></a>  area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(shp)</span>
<span id="cb232-12"><a href="spatial-analysis.html#cb232-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-13"><a href="spatial-analysis.html#cb232-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># put the area into the vector</span></span>
<span id="cb232-14"><a href="spatial-analysis.html#cb232-14" aria-hidden="true" tabindex="-1"></a>  area_list <span class="ot">&lt;-</span> <span class="fu">c</span>(area_list, area)</span>
<span id="cb232-15"><a href="spatial-analysis.html#cb232-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb232-16"><a href="spatial-analysis.html#cb232-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-17"><a href="spatial-analysis.html#cb232-17" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------X</span></span>
<span id="cb232-18"><a href="spatial-analysis.html#cb232-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-19"><a href="spatial-analysis.html#cb232-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Example 2: Load a set of shapefiles, generate a buffer for each, and calculate the  #            mean value of a raster within that buffer and the focal feature</span></span>
<span id="cb232-20"><a href="spatial-analysis.html#cb232-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-21"><a href="spatial-analysis.html#cb232-21" aria-hidden="true" tabindex="-1"></a>filenames <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir) <span class="co"># get a list of shapefile names in a directory</span></span>
<span id="cb232-22"><a href="spatial-analysis.html#cb232-22" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">raster</span>(raster_filename) <span class="co"># load a raster</span></span>
<span id="cb232-23"><a href="spatial-analysis.html#cb232-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-24"><a href="spatial-analysis.html#cb232-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(filenames, <span class="cf">function</span>(fn){</span>
<span id="cb232-25"><a href="spatial-analysis.html#cb232-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load a shapefile</span></span>
<span id="cb232-26"><a href="spatial-analysis.html#cb232-26" aria-hidden="true" tabindex="-1"></a>  shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(fn)</span>
<span id="cb232-27"><a href="spatial-analysis.html#cb232-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-28"><a href="spatial-analysis.html#cb232-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generate a 10kmX10km buffer </span></span>
<span id="cb232-29"><a href="spatial-analysis.html#cb232-29" aria-hidden="true" tabindex="-1"></a>  buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(shp, <span class="at">dist =</span> <span class="dv">10000</span>)</span>
<span id="cb232-30"><a href="spatial-analysis.html#cb232-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-31"><a href="spatial-analysis.html#cb232-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># crop the raster to the shape and the buffer</span></span>
<span id="cb232-32"><a href="spatial-analysis.html#cb232-32" aria-hidden="true" tabindex="-1"></a>  r_shp <span class="ot">&lt;-</span> <span class="fu">crop</span>(r, <span class="fu">extent</span>(shp))</span>
<span id="cb232-33"><a href="spatial-analysis.html#cb232-33" aria-hidden="true" tabindex="-1"></a>  r_buffer <span class="ot">&lt;-</span> <span class="fu">crop</span>(r, <span class="fu">extent</span>(buffer))</span>
<span id="cb232-34"><a href="spatial-analysis.html#cb232-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-35"><a href="spatial-analysis.html#cb232-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the mean value of the raster within the buffer and the feature</span></span>
<span id="cb232-36"><a href="spatial-analysis.html#cb232-36" aria-hidden="true" tabindex="-1"></a>  r_shp_mean <span class="ot">&lt;-</span> <span class="fu">cellStats</span>(r_shp, <span class="at">stat =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb232-37"><a href="spatial-analysis.html#cb232-37" aria-hidden="true" tabindex="-1"></a>  r_buff_mean <span class="ot">&lt;-</span> <span class="fu">cellStats</span>(r_shp, <span class="at">stat =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb232-38"><a href="spatial-analysis.html#cb232-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-39"><a href="spatial-analysis.html#cb232-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return both means in a list</span></span>
<span id="cb232-40"><a href="spatial-analysis.html#cb232-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(r_shp_mean, r_buff_mean))</span>
<span id="cb232-41"><a href="spatial-analysis.html#cb232-41" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb232-42"><a href="spatial-analysis.html#cb232-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-43"><a href="spatial-analysis.html#cb232-43" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------X</span></span>
<span id="cb232-44"><a href="spatial-analysis.html#cb232-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-45"><a href="spatial-analysis.html#cb232-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Example 3: Generate a raster of the sum from a set of RasterStacks</span></span>
<span id="cb232-46"><a href="spatial-analysis.html#cb232-46" aria-hidden="true" tabindex="-1"></a><span class="co">#            and then save the output raster</span></span>
<span id="cb232-47"><a href="spatial-analysis.html#cb232-47" aria-hidden="true" tabindex="-1"></a>filenames <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir) <span class="co"># get a list of raster files in a directory</span></span>
<span id="cb232-48"><a href="spatial-analysis.html#cb232-48" aria-hidden="true" tabindex="-1"></a>out_names <span class="ot">&lt;-</span> <span class="fu">paste0</span>(filenames, <span class="st">&quot;_sum&quot;</span>)</span>
<span id="cb232-49"><a href="spatial-analysis.html#cb232-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-50"><a href="spatial-analysis.html#cb232-50" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(filenames), <span class="cf">function</span>(i){</span>
<span id="cb232-51"><a href="spatial-analysis.html#cb232-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load RasterStak</span></span>
<span id="cb232-52"><a href="spatial-analysis.html#cb232-52" aria-hidden="true" tabindex="-1"></a>  stk <span class="ot">&lt;-</span> <span class="fu">stack</span>(filenames[i])</span>
<span id="cb232-53"><a href="spatial-analysis.html#cb232-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-54"><a href="spatial-analysis.html#cb232-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a raster that is the sum of all layers in the stack</span></span>
<span id="cb232-55"><a href="spatial-analysis.html#cb232-55" aria-hidden="true" tabindex="-1"></a>  sum <span class="ot">&lt;-</span> <span class="fu">calc</span>(stk, <span class="at">fun =</span> sum)</span>
<span id="cb232-56"><a href="spatial-analysis.html#cb232-56" aria-hidden="true" tabindex="-1"></a>  sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(stk) <span class="co"># these two operations are equivalent</span></span>
<span id="cb232-57"><a href="spatial-analysis.html#cb232-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-58"><a href="spatial-analysis.html#cb232-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(sum, out_names[i], <span class="at">format =</span> <span class="st">&quot;GTiff&quot;</span>)</span>
<span id="cb232-59"><a href="spatial-analysis.html#cb232-59" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb232-60"><a href="spatial-analysis.html#cb232-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-61"><a href="spatial-analysis.html#cb232-61" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------X</span></span>
<span id="cb232-62"><a href="spatial-analysis.html#cb232-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-63"><a href="spatial-analysis.html#cb232-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Example 4: Pull the number of zeros in a set of rasters</span></span>
<span id="cb232-64"><a href="spatial-analysis.html#cb232-64" aria-hidden="true" tabindex="-1"></a>filenames <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir) <span class="co"># get a list of raster files in a directory</span></span>
<span id="cb232-65"><a href="spatial-analysis.html#cb232-65" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(filenames, <span class="cf">function</span>(fn){</span>
<span id="cb232-66"><a href="spatial-analysis.html#cb232-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load raster</span></span>
<span id="cb232-67"><a href="spatial-analysis.html#cb232-67" aria-hidden="true" tabindex="-1"></a>  rast <span class="ot">&lt;-</span> <span class="fu">raster</span>(fn)</span>
<span id="cb232-68"><a href="spatial-analysis.html#cb232-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-69"><a href="spatial-analysis.html#cb232-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the number of zeros in the raster</span></span>
<span id="cb232-70"><a href="spatial-analysis.html#cb232-70" aria-hidden="true" tabindex="-1"></a>  n_0 <span class="ot">&lt;-</span> <span class="fu">getValues</span>(rast) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">%&gt;%</span></span>
<span id="cb232-71"><a href="spatial-analysis.html#cb232-71" aria-hidden="true" tabindex="-1"></a>      <span class="fu">which</span>() <span class="sc">%&gt;%</span></span>
<span id="cb232-72"><a href="spatial-analysis.html#cb232-72" aria-hidden="true" tabindex="-1"></a>      <span class="fu">length</span>()</span>
<span id="cb232-73"><a href="spatial-analysis.html#cb232-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(n_0)</span>
<span id="cb232-74"><a href="spatial-analysis.html#cb232-74" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Even more efficient would be to run these in parallel, but that is way beyond the scope of this workshop</p>
<hr />
<p>I hope these functions helped you! The next chapter goes over some ways of obtaining the data we worked on today.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="spatial-data-in-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="where-to-obtain-data-further-resources.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://https://github.com/ronanhart/R_spatial_workshop/03-Spatial_analysis.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
